# ğŸ—ï¸ SYSTEM ARCHITECTURE - PAYMENT & PARTNER SYSTEM

**VisÃ£o Geral da ImplementaÃ§Ã£o Completa do Sistema de Pagamento e Parceiros**

---

## ğŸ“ ARQUITETURA GERAL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FRONTEND (Browser)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Checkout Page   â”‚  â”‚  Verify Email    â”‚  â”‚   Partner    â”‚  â”‚
â”‚  â”‚  (CardElement)   â”‚  â”‚     Page         â”‚  â”‚  Dashboard   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                    â”‚                   â”‚           â”‚
â”‚     /checkout              /register            /dashboard-    â”‚
â”‚     ?orderId=...          ?email=...            parceiro       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                    â”‚                   â”‚
             â–¼                    â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Stripe.js      â”‚   â”‚ Next.js Client â”‚   â”‚ useEffect      â”‚
    â”‚ confirmCardPay â”‚   â”‚ fetch() POST   â”‚   â”‚ fetch() GET    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                    â”‚                   â”‚
             â”‚ clientSecret       â”‚ email + token     â”‚ partnerId
             â”‚                    â”‚                   â”‚
             â–¼                    â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      BACKEND (Next.js API)                      â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           API ROUTES (src/app/api/)                     â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚         PAYMENTS SYSTEM                        â”‚     â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚   â”‚
â”‚  â”‚  â”‚                                                â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  POST /payments/create-intent                 â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Validate order                            â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Create Stripe PaymentIntent               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Store stripe_intent_id in DB              â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Return clientSecret                       â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                                                â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  POST /payments/stripe-webhook                â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Verify Stripe signature                   â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Handle payment events:                    â”‚     â”‚   â”‚
â”‚  â”‚  â”‚     â”œâ”€ payment_intent.succeeded               â”‚     â”‚   â”‚
â”‚  â”‚  â”‚     â”œâ”€ payment_intent.payment_failed          â”‚     â”‚   â”‚
â”‚  â”‚  â”‚     â””â”€ charge.refunded                        â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Update order status                       â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Create partner_sales records              â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Send confirmation email                   â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Log audit trail                           â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                                                â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚         EMAIL SYSTEM                           â”‚     â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚   â”‚
â”‚  â”‚  â”‚                                                â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  POST /emails/send                            â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Validate email type                       â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Build HTML template                       â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Call Resend API                           â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Log sent email in DB                      â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Return messageId                          â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                                                â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  Email Types:                                 â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ confirmation (signup verification)        â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ order (order confirmation)                â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ tracking (shipment dispatch)              â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â”œâ”€ shipment (delivery confirmation)          â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ partner_sale (partner notification)       â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                                                â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚         AUTHENTICATION SYSTEM                  â”‚     â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚   â”‚
â”‚  â”‚  â”‚                                                â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  POST /auth/verify-email                      â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Generate 24-hour token                    â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Store token in DB                         â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Send verification email                   â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Return token info                         â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                                                â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  GET /auth/verify-email?token=...             â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Validate token (not expired, exists)      â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Mark profile as email_verified            â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Delete used token                         â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Return success                            â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                                                â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚         PARTNER SYSTEM                         â”‚     â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚   â”‚
â”‚  â”‚  â”‚                                                â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  GET /partners/dashboard?partnerId=...        â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Fetch partner metrics                     â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Calculate commissions (from partner_sales)â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Fetch sales list with pagination          â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Fetch payout history                      â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Fetch top products                        â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                                                â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  POST /partners/dashboard                     â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Validate date range                       â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Calculate total commission for period     â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Create payout request record              â”‚     â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€ Send notification email to partner        â”‚     â”‚   â”‚
â”‚  â”‚  â”‚                                                â”‚     â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           SECURITY & VERIFICATION                       â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  â€¢ Stripe webhook signature verification                â”‚   â”‚
â”‚  â”‚  â€¢ CORS validation                                       â”‚   â”‚
â”‚  â”‚  â€¢ Supabase RLS (Row Level Security)                    â”‚   â”‚
â”‚  â”‚  â€¢ Service role key for backend operations              â”‚   â”‚
â”‚  â”‚  â€¢ Token expiration (24 hours)                          â”‚   â”‚
â”‚  â”‚  â€¢ Order ownership validation                            â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                    â”‚                   â”‚
             â”‚ clientSecret       â”‚ token             â”‚ metrics
             â”‚ response           â”‚ response          â”‚ response
             â”‚                    â”‚                   â”‚
             â–¼                    â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Stripe Client  â”‚   â”‚ Window.locationâ”‚   â”‚ React State    â”‚
    â”‚ confirmPayment â”‚   â”‚ redirect       â”‚   â”‚ setData()      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                    â”‚                   â”‚
             â”‚ payment            â”‚                   â”‚
             â”‚ confirmation       â”‚                   â”‚ Render
             â”‚ event              â”‚                   â”‚ dashboard
             â”‚                    â”‚                   â”‚
             â–¼                    â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ User sees      â”‚   â”‚ User email     â”‚   â”‚ Partner sees   â”‚
    â”‚ "Payment OK"   â”‚   â”‚ verified âœ“     â”‚   â”‚ sales + $$ madeâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ DATABASE SCHEMA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SUPABASE POSTGRESQL                        â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚     ORDERS          â”‚      â”‚    PRODUCTS         â”‚        â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚ id (PK)             â”‚â—„â”€â”€â”€â”€â”€â”‚ id (PK)             â”‚        â”‚
â”‚  â”‚ user_id (FK)        â”‚  â–²   â”‚ name                â”‚        â”‚
â”‚  â”‚ total_amount        â”‚  â”‚   â”‚ price               â”‚        â”‚
â”‚  â”‚                     â”‚  â”‚   â”‚ partner_id (FK)     â”‚        â”‚
â”‚  â”‚ [NEW] stripe_       â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”‚       intent_id     â”‚  â”‚                                   â”‚
â”‚  â”‚ [NEW] payment_      â”‚  â”‚                                   â”‚
â”‚  â”‚       status        â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ [NEW] paid_at       â”‚  â”‚   â”‚   PARTNERS           â”‚        â”‚
â”‚  â”‚ [NEW] payment_      â”‚  â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚
â”‚  â”‚       error_msg     â”‚  â”‚   â”‚ id (PK)              â”‚        â”‚
â”‚  â”‚                     â”‚  â””â”€â”€â”€â”‚ user_id (FK)         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ commission_rate      â”‚        â”‚
â”‚            â”‚ 1-N              â”‚ verified             â”‚        â”‚
â”‚            â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚            â”‚                                                   â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚                       â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚      PARTNER_SALES (NEW!)                â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚ id (PK)                                  â”‚                â”‚
â”‚  â”‚ partner_id (FK) â”€â”€â”€â”€â”€â”€â–º PARTNERS         â”‚                â”‚
â”‚  â”‚ order_id (FK) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ORDERS         â”‚                â”‚
â”‚  â”‚ product_id (FK) â”€â”€â”€â”€â”€â”€â”€â–º PRODUCTS        â”‚                â”‚
â”‚  â”‚ amount (INT) - sale price in cents       â”‚                â”‚
â”‚  â”‚ commission (INT) - 10% of amount         â”‚                â”‚
â”‚  â”‚ status (pending/completed/payout_proc)   â”‚                â”‚
â”‚  â”‚ created_at (TIMESTAMP)                   â”‚                â”‚
â”‚  â”‚ updated_at (TIMESTAMP)                   â”‚                â”‚
â”‚  â”‚                                          â”‚                â”‚
â”‚  â”‚ Indexes: partner_id, order_id, status    â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚            1-N                                                â”‚
â”‚            â”‚                                                  â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚                       â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚      PARTNER_PAYOUTS (NEW!)              â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚ id (PK)                                  â”‚                â”‚
â”‚  â”‚ partner_id (FK) â”€â”€â”€â”€â”€â”€â–º PARTNERS         â”‚                â”‚
â”‚  â”‚ amount (INT) - total payout in cents     â”‚                â”‚
â”‚  â”‚ status (pending/processing/completed)    â”‚                â”‚
â”‚  â”‚ date_from (DATE) - period start          â”‚                â”‚
â”‚  â”‚ date_to (DATE) - period end              â”‚                â”‚
â”‚  â”‚ notes (TEXT)                             â”‚                â”‚
â”‚  â”‚ created_at (TIMESTAMP)                   â”‚                â”‚
â”‚  â”‚ processed_at (TIMESTAMP)                 â”‚                â”‚
â”‚  â”‚                                          â”‚                â”‚
â”‚  â”‚ Indexes: partner_id, status, created_at  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚  EMAIL_VERIFICATION_TOKENS (NEW!)        â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚ id (PK)                                  â”‚                â”‚
â”‚  â”‚ email (TEXT)                             â”‚                â”‚
â”‚  â”‚ token (TEXT UNIQUE)                      â”‚                â”‚
â”‚  â”‚ expires_at (TIMESTAMP) - 24 hours        â”‚                â”‚
â”‚  â”‚ used_at (TIMESTAMP) - when validated     â”‚                â”‚
â”‚  â”‚ created_at (TIMESTAMP)                   â”‚                â”‚
â”‚  â”‚                                          â”‚                â”‚
â”‚  â”‚ Indexes: email, token, expires_at        â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚      EMAIL_LOGS (NEW!)                   â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚ id (PK)                                  â”‚                â”‚
â”‚  â”‚ type (confirmation/order/tracking/etc)   â”‚                â”‚
â”‚  â”‚ recipient (email address)                â”‚                â”‚
â”‚  â”‚ status (sent/failed/bounced)             â”‚                â”‚
â”‚  â”‚ message_id (from Resend)                 â”‚                â”‚
â”‚  â”‚ error_message (if failed)                â”‚                â”‚
â”‚  â”‚ metadata (JSONB) - context info          â”‚                â”‚
â”‚  â”‚ created_at (TIMESTAMP)                   â”‚                â”‚
â”‚  â”‚                                          â”‚                â”‚
â”‚  â”‚ Indexes: recipient, type, status, date   â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚      AUDIT_LOGS (NEW!)                   â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚ id (PK)                                  â”‚                â”‚
â”‚  â”‚ action (payment_received/payout_created) â”‚                â”‚
â”‚  â”‚ order_id (FK) â”€â”€â”€â”€â”€â”€â”€â”€â–º ORDERS           â”‚                â”‚
â”‚  â”‚ user_id (FK) â”€â”€â”€â”€â”€â”€â”€â”€â–º AUTH.USERS        â”‚                â”‚
â”‚  â”‚ partner_id (FK) â”€â”€â”€â”€â”€â”€â”€â–º PARTNERS        â”‚                â”‚
â”‚  â”‚ details (JSONB) - full context           â”‚                â”‚
â”‚  â”‚ ip_address (TEXT)                        â”‚                â”‚
â”‚  â”‚ user_agent (TEXT)                        â”‚                â”‚
â”‚  â”‚ created_at (TIMESTAMP)                   â”‚                â”‚
â”‚  â”‚                                          â”‚                â”‚
â”‚  â”‚ Indexes: order_id, user_id, action, date â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚      PROFILES (UPDATED!)                 â”‚                â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚  â”‚ id (PK)                                  â”‚                â”‚
â”‚  â”‚ (existing fields...)                     â”‚                â”‚
â”‚  â”‚                                          â”‚                â”‚
â”‚  â”‚ [NEW] email_verified (BOOLEAN)           â”‚                â”‚
â”‚  â”‚ [NEW] verified_at (TIMESTAMP)            â”‚                â”‚
â”‚  â”‚ [NEW] email_verification_sent_at         â”‚                â”‚
â”‚  â”‚ [NEW] email_verification_attempts        â”‚                â”‚
â”‚  â”‚                                          â”‚                â”‚
â”‚  â”‚ Indexes: email_verified                  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ DATA FLOW DIAGRAMS

### Flow 1: Pagamento Completo

```
CLIENTE             API             STRIPE            DATABASE
   â”‚                 â”‚                 â”‚                  â”‚
   â”œâ”€ Checkout â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚                  â”‚
   â”‚                 â”‚                 â”‚                  â”‚
   â”‚                 â”œâ”€ Create Intentâ”€â–ºâ”‚                  â”‚
   â”‚                 â”‚                 â”‚                  â”‚
   â”‚                 â”‚â—„â”€ clientSecret â”€â”¤                  â”‚
   â”‚                 â”‚                 â”‚                  â”‚
   â”‚â—„â”€ Show Form â”€â”€â”€â”€â”¤                 â”‚                  â”‚
   â”‚                 â”‚                 â”‚                  â”‚
   â”œâ”€ Fill Card â”€â”€â”€â”€â–ºâ”‚                 â”‚                  â”‚
   â”‚ 4242-4242...    â”‚                 â”‚                  â”‚
   â”‚                 â”œâ”€ Confirm Paymentâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
   â”‚                 â”‚                 â”‚                  â”‚
   â”‚                 â”‚                 â”œâ”€ Process Card    â”‚
   â”‚                 â”‚                 â”‚ (bank auth)      â”‚
   â”‚                 â”‚                 â”‚                  â”‚
   â”‚                 â”‚         â”Œâ”€â”€â”€â”€â”€â”€â–ºâ”‚                  â”‚
   â”‚                 â”‚         â”‚       â”‚ (Stripe call)    â”‚
   â”‚                 â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                  â”‚
   â”‚                 â”‚ success         â”‚                  â”‚
   â”‚                 â”‚                 â”œâ”€ Webhook POST    â”‚
   â”‚                 â”‚                 â”‚ (payment_intent. â”‚
   â”‚                 â”‚                 â”‚  succeeded)      â”‚
   â”‚                 â”‚                 â”‚                  â”‚
   â”‚                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–º Update Order   â”‚
   â”‚                 â”‚                 â”‚    Status=PAID   â”‚
   â”‚                 â”‚                 â”‚                  â”‚
   â”‚                 â”‚                 â”‚    Create Partnerâ”‚
   â”‚                 â”‚                 â”‚    Sales (10% %) â”‚
   â”‚                 â”‚                 â”‚                  â”‚
   â”‚â—„â”€ "Success" â”€â”€â”€â”€â”¤                 â”‚    Log Audit     â”‚
   â”‚ Redirect        â”‚                 â”‚                  â”‚
   â”‚ /order/confirm  â”‚                 â”‚ Send Email â”€â”€â”€â”€â–º â”‚
   â”‚                 â”‚                 â”‚ Confirmation     â”‚
```

### Flow 2: VerificaÃ§Ã£o de Email

```
CLIENTE             API             EMAIL          DATABASE
   â”‚                 â”‚                 â”‚              â”‚
   â”œâ”€ Register â”€â”€â”€â”€â”€â–ºâ”‚                 â”‚              â”‚
   â”‚ email@ex.com    â”‚                 â”‚              â”‚
   â”‚ password        â”‚                 â”‚              â”‚
   â”‚                 â”‚                 â”‚              â”‚
   â”‚                 â”œâ”€ Create Auth    â”‚              â”‚
   â”‚                 â”‚ Supabase        â”‚              â”‚
   â”‚                 â”‚                 â”‚              â”‚
   â”‚                 â”œâ”€ Generate Token â”‚              â”‚
   â”‚                 â”‚ (24h expiry)    â”‚              â”‚
   â”‚                 â”‚                 â”‚              â”‚
   â”‚                 â”‚                 â”œâ”€ Store Tokenâ”€â–ºâ”‚
   â”‚                 â”‚                 â”‚  verify_token â”‚
   â”‚                 â”‚                 â”‚              â”‚
   â”‚                 â”œâ”€ Call Resend â”€â”€â–ºâ”‚              â”‚
   â”‚                 â”‚                 â”œâ”€ Send Email   â”‚
   â”‚                 â”‚â—„â”€ messageId â”€â”€â”€â”€â”¤ with link    â”‚
   â”‚                 â”‚                 â”‚              â”‚
   â”‚â—„â”€ "Check email" â”¤                 â”‚              â”‚
   â”‚ for link        â”‚                 â”‚              â”‚
   â”‚                 â”‚                 â”‚              â”‚
   â”œâ”€ Click link â”€â”€â”€â–ºâ”‚                 â”‚              â”‚
   â”‚ /verify?token=..â”‚ GET             â”‚              â”‚
   â”‚                 â”‚                 â”‚              â”‚
   â”‚                 â”œâ”€ Validate Token â”‚              â”‚
   â”‚                 â”‚ Not expired?    â”‚              â”‚
   â”‚                 â”‚                 â”‚ Mark Verified â”‚
   â”‚                 â”‚                 â”œâ”€ UPDATE â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                 â”‚                 â”‚  profile      â”‚
   â”‚                 â”‚                 â”‚  email_veri=T â”‚
   â”‚                 â”‚                 â”‚              â”‚
   â”‚                 â”‚                 â”‚ Delete Token â”€â–ºâ”‚
   â”‚                 â”‚                 â”‚              â”‚
   â”‚â—„â”€ "Verified" â”€â”€â”€â”¤                 â”‚              â”‚
   â”‚ Redirect /login â”‚                 â”‚              â”‚
```

### Flow 3: Dashboard de Parceiro

```
PARCEIRO            API             DATABASE
   â”‚                 â”‚                 â”‚
   â”œâ”€ Open Dashboardâ–ºâ”‚                 â”‚
   â”‚                 â”œâ”€ GET /dashboard â”‚
   â”‚                 â”‚ ?partnerId=xyz  â”‚
   â”‚                 â”‚                 â”‚
   â”‚                 â”œâ”€ Query Partner  â”‚
   â”‚                 â”‚ Sales â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                 â”‚                 â”œâ”€ SELECT SUM  â”‚
   â”‚                 â”‚                 â”‚ amount,       â”‚
   â”‚                 â”‚                 â”‚ commission    â”‚
   â”‚                 â”‚                 â”‚ FROM          â”‚
   â”‚                 â”‚                 â”‚ partner_sales â”‚
   â”‚                 â”‚â—„â”€ Sales List â”€â”€â”€â”¤ WHERE ...     â”‚
   â”‚                 â”‚                 â”‚               â”‚
   â”‚                 â”œâ”€ Calculate Metrics
   â”‚                 â”‚ - Total Sales   â”‚
   â”‚                 â”‚ - Total Commission
   â”‚                 â”‚ - Completed vs Pending
   â”‚                 â”‚                 â”‚
   â”‚                 â”œâ”€ Fetch Payouts â”€â”¤
   â”‚                 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                 â”‚ (payout history)â”‚
   â”‚                 â”‚â—„â”€ Payouts List â”€â”¤
   â”‚                 â”‚                 â”‚
   â”‚â—„â”€ Dashboard â”€â”€â”€â”€â”‚                 â”‚
   â”‚ + Metrics       â”‚                 â”‚
   â”‚ + Sales List    â”‚                 â”‚
   â”‚ + Payouts       â”‚                 â”‚
   â”‚                 â”‚                 â”‚
   â”œâ”€ Click "Payout"â–ºâ”‚ POST /dashboard â”‚
   â”‚ Request         â”‚ dateFrom/to     â”‚
   â”‚                 â”‚                 â”‚
   â”‚                 â”œâ”€ Sum comissions â”‚
   â”‚                 â”‚ for period â”€â”€â”€â”€â–ºâ”‚
   â”‚                 â”‚                 â”œâ”€ CREATE      â”‚
   â”‚                 â”‚                 â”‚ payout req   â”‚
   â”‚                 â”‚                 â”‚ status=      â”‚
   â”‚                 â”‚                 â”‚ pending      â”‚
   â”‚                 â”‚                 â”‚              â”‚
   â”‚                 â”œâ”€ Send Email â”€â”€â”€â–ºâ”‚
   â”‚                 â”‚ "Payout        â”‚
   â”‚                 â”‚ Requested"     â”‚
   â”‚                 â”‚                 â”‚
   â”‚â—„â”€ "OK" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
   â”‚ Payout          â”‚                 â”‚
   â”‚ Requested!      â”‚                 â”‚
```

---

## ğŸ” SECURITY MODEL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SECURITY LAYERS                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  Layer 1: HTTPS/TLS                         â”‚
â”‚  â”œâ”€ All traffic encrypted                   â”‚
â”‚  â””â”€ Prevents MITM attacks                   â”‚
â”‚                                             â”‚
â”‚  Layer 2: AUTHENTICATION                    â”‚
â”‚  â”œâ”€ Supabase Auth (JWT tokens)              â”‚
â”‚  â””â”€ Only authenticated users can call API   â”‚
â”‚                                             â”‚
â”‚  Layer 3: AUTHORIZATION (RLS)               â”‚
â”‚  â”œâ”€ Stripe Webhook: Signature verification  â”‚
â”‚  â”‚  â””â”€ Only Stripe can call webhook         â”‚
â”‚  â”œâ”€ Order operations: Ownership check       â”‚
â”‚  â”‚  â””â”€ User can only access their orders    â”‚
â”‚  â””â”€ Partner operations: Ownership check     â”‚
â”‚     â””â”€ Partner can only access their data   â”‚
â”‚                                             â”‚
â”‚  Layer 4: DATA VALIDATION                   â”‚
â”‚  â”œâ”€ Email format validation                 â”‚
â”‚  â”œâ”€ Amount integer validation (cents)       â”‚
â”‚  â”œâ”€ Order existence check                   â”‚
â”‚  â””â”€ Token expiration check                  â”‚
â”‚                                             â”‚
â”‚  Layer 5: ENCRYPTION                        â”‚
â”‚  â”œâ”€ Secrets stored in .env (not in code)    â”‚
â”‚  â”œâ”€ Service role key only on backend        â”‚
â”‚  â”œâ”€ Never log sensitive data                â”‚
â”‚  â””â”€ PCI compliance via Stripe               â”‚
â”‚                                             â”‚
â”‚  Layer 6: AUDIT TRAIL                       â”‚
â”‚  â”œâ”€ All payments logged                     â”‚
â”‚  â”œâ”€ All emails logged                       â”‚
â”‚  â”œâ”€ All auth events logged                  â”‚
â”‚  â””â”€ All commission calculations logged      â”‚
â”‚                                             â”‚
â”‚  Layer 7: RATE LIMITING                     â”‚
â”‚  â”œâ”€ Prevent brute force                     â”‚
â”‚  â”œâ”€ Prevent spam                            â”‚
â”‚  â””â”€ Prevent DDoS (on production)            â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš™ï¸ INTEGRATION POINTS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         EXTERNAL INTEGRATIONS                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                              â”‚
â”‚  âœ… STRIPE (Payment Processing)              â”‚
â”‚     â”œâ”€ API: Create PaymentIntent             â”‚
â”‚     â”œâ”€ Webhook: payment_intent.succeeded     â”‚
â”‚     â””â”€ SDK: Stripe.js (browser confirmation) â”‚
â”‚                                              â”‚
â”‚  âœ… RESEND (Email Service)                   â”‚
â”‚     â”œâ”€ API: Send email                       â”‚
â”‚     â”œâ”€ Templates: HTML emails                â”‚
â”‚     â””â”€ Domain: Custom or resend.dev          â”‚
â”‚                                              â”‚
â”‚  âœ… SUPABASE (Database & Auth)               â”‚
â”‚     â”œâ”€ Auth: Supabase Auth                   â”‚
â”‚     â”œâ”€ DB: PostgreSQL                        â”‚
â”‚     â””â”€ RLS: Row Level Security               â”‚
â”‚                                              â”‚
â”‚  â³ FUTURE: CEP/Address (Optional)           â”‚
â”‚     â”œâ”€ viacep.com.br (free)                  â”‚
â”‚     â””â”€ For shipping validation               â”‚
â”‚                                              â”‚
â”‚  â³ FUTURE: Tracking (Partner Choice)        â”‚
â”‚     â”œâ”€ Melhor Envio                          â”‚
â”‚     â”œâ”€ Loggi                                 â”‚
â”‚     â”œâ”€ Correios                              â”‚
â”‚     â””â”€ Custom integration                    â”‚
â”‚                                              â”‚
â”‚  â³ FUTURE: Analytics (Optional)             â”‚
â”‚     â”œâ”€ Sentry: Error tracking                â”‚
â”‚     â””â”€ Lighthouse: Performance               â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ SCALABILITY CONSIDERATIONS

```
CURRENT SETUP (Development)
â”œâ”€ Stripe: Test mode (unlimited test payments)
â”œâ”€ Resend: 100 emails/day free tier
â”œâ”€ Supabase: Free tier
â””â”€ Next.js: Single instance (Vercel)

SCALING TO PRODUCTION
â”œâ”€ Stripe: Live mode (handles millions of txs)
â”œâ”€ Resend: Paid tier or self-hosted SMTP
â”œâ”€ Supabase: Scale DB as needed
â””â”€ Next.js: Auto-scale on Vercel

PERFORMANCE OPTIMIZATIONS
â”œâ”€ Database: 13 indexes for fast queries
â”œâ”€ API: Stateless (can scale horizontally)
â”œâ”€ Webhooks: Async processing (doesn't block)
â””â”€ Frontend: Code splitting + Image optimization
```

---

## ğŸ¯ SYSTEM READINESS

```
COMPONENT READINESS:

Payment System         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 90% (ready, needs FE)
Email System           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 90% (ready, needs FE)
Partner Dashboard      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 90% (ready, needs FE)
Email Verification     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 90% (ready, needs FE)
Database Schema        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% (complete)
API Routes             â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% (complete)
Authentication         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 75% (FE integration needed)
Frontend Components    â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 20% (need to create)
External Integrations  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 20% (partially configured)

OVERALL: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 70% READY
```

---

**Sistema pronto para integraÃ§Ã£o do frontend!** ğŸš€

Este diagrama mostra todos os 5 APIs jÃ¡ criadas e como eles trabalham juntos para processar pagamentos, enviar emails, verificar emails, e rastrear comissÃµes de parceiros.
